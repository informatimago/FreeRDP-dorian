#!/bin/bash

KRB5CONFIG=$(which krb5-config)
KRB5PREFIX=$(($KRB5CONFIG --prefix) 2>&1)
KRB5VENDOR=$(($KRB5CONFIG --vendor) 2>&1)

if [ $1 = "Heimdal" ]; then
  if ! [[ $PATH =~ [H|h]eimdal ]]; then
    # Heimdal not set in path(*). Here we are supposed to be in a \case
    # where MIT is installed and running over Heimdal (unless Heimdal is being
    # installed in a non-default directory, so no "heimdal" string presents in PATH).
    # We set it by default to the default installation of Heimdal (/usr/heimdal).
    # If you want an other PATH please specify KRB_INSTALLED_PREFIX.
    # (*) Note in the particular \case where Heimdal is already running,
    # the Heimdal PATH is one of the default existing paths.
    if [[ $2 = "" ]]; then
      if [[ $KRB5VENDOR =~ [H|h]eimdal$ ]]; then
        echo "Heimdal is already being set as Kerberos flavour"
        MESSAGE=true
      else
        export PATH=/usr/heimdal/bin:$PATH
      fi
    else
      SHAVED_PREFIX_DIR=`echo -e "$2" | sed -e 's/\/$//'`
      if [[ $KRB5VENDOR =~ [H|h]eimdal$ ]]; then
        echo "Heimdal is already being set as Kerberos flavour"
        MESSAGE=true
      else
        export PATH=$SHAVED_PREFIX_DIR/bin:$PATH
      fi
    fi
  else
    # delete Heimdal in PATH and export PATH with Heimdal
    # to ensure Heimdal is first Kerberos in PATH
    ORIGIN_PATH=$PATH
    CURRENT_PATH=$PATH
    PATH_DELETED=
    while true
    do
      HEIMDAL_PATH=`echo ${CURRENT_PATH%%:*}`
      if [[ $PATH_DELETED = "" ]]; then
        PATH_DELETED=$HEIMDAL_PATH
      else
        PATH_DELETED=$PATH_DELETED:$HEIMDAL_PATH
      fi
      CURRENT_PATH=`echo ${CURRENT_PATH#*:}`
      if [[ $HEIMDAL_PATH =~ [H|h]eimdal ]] && ! [[ $CURRENT_PATH =~ [H|h]eimdal ]]; then
        break
      fi
    done

    NEW_PATH=`echo ${ORIGIN_PATH/$PATH_DELETED:/}`

    if ! [[ $2 = "" ]]; then
      SHAVED_PREFIX_DIR=`echo -e "$2" | sed -e 's/\/$//'`
      MY_PATH=$SHAVED_PREFIX_DIR/bin:$NEW_PATH
      export PATH=$MY_PATH
    else
      if [[ $KRB5VENDOR =~ [H|h]eimdal$ ]]; then
        echo "Heimdal is already being set as Kerberos flavour"
        MESSAGE=true
        export PATH=$KRB5PREFIX/bin:$NEW_PATH
      else
        ANSWER=no
        while ! [[ $ANSWER =~ [Y|y] ]] && ! [[ $ANSWER =~ [Y|y]es ]] && ! [[ $ANSWER = "" ]]
        do
          read -p "Please specify prefix directory of your Heimdal installation : " YOURPREFIX
          echo "You entered : $YOURPREFIX. OK ? [Y/n]"
          read ANSWER
        done
        SHAVED_PREFIX_DIR=`echo -e "$YOURPREFIX" | sed -e 's/\/$//'`
        export PATH=$SHAVED_PREFIX_DIR/bin:$NEW_PATH
      fi
    fi
  fi
else
  if [[ $KRB5CONFIG =~ [H|h]eimdal ]]; then
    # delete Heimdal in PATH
    ORIGIN_PATH=$PATH
    CURRENT_PATH=$PATH
    PATH_DELETED=

    while true
    do
      HEIMDAL_PATH=`echo ${CURRENT_PATH%%:*}`
      if [[ $PATH_DELETED = "" ]]; then
        PATH_DELETED=$HEIMDAL_PATH
      else
        PATH_DELETED=$PATH_DELETED:$HEIMDAL_PATH
      fi
      CURRENT_PATH=`echo ${CURRENT_PATH#*:}`
      if [[ $HEIMDAL_PATH =~ [H|h]eimdal ]] && ! [[ $CURRENT_PATH =~ [H|h]eimdal ]]; then
        break
      fi
    done

    NEW_PATH=`echo ${ORIGIN_PATH/$PATH_DELETED:/}`

    if [[ $3 = "" ]]; then
      export PATH=$NEW_PATH
    else
      SHAVED_PREFIX_DIR=`echo -e "$3" | sed -e 's/\/$//'`
      export PATH=$SHAVED_PREFIX_DIR/bin:$PATH
    fi
  else
     if [[ $KRB5VENDOR =~ [H|h]eimdal$ ]]; then
        if [[ $3 = "" ]]; then
          ANSWER=no
          while ! [[ $ANSWER =~ [Y|y] ]] && ! [[ $ANSWER =~ [Y|y]es ]] && ! [[ $ANSWER = "" ]]
          do
            read -p "Please specify prefix directory of your MIT installation : " YOURPREFIX
            echo "You entered : $YOURPREFIX. OK ? [Y/n]"
            read ANSWER
          done
          SHAVED_PREFIX_DIR=`echo -e "$YOURPREFIX" | sed -e 's/\/$//'`
          export PATH=$SHAVED_PREFIX_DIR/bin:$PATH
        else
          SHAVED_PREFIX_DIR=`echo -e "$3" | sed -e 's/\/$//'`
          export PATH=$SHAVED_PREFIX_DIR/bin:$PATH
        fi
     else
       echo "MIT is already being set as Kerberos flavour"
       MESSAGE=true
     fi
  fi
fi
